<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Pulmuone</title>
  <style media="screen">

  </style>
</head>

<body>
</body>
<script type="text/javascript" src="./js/phaser.min.js"></script>
<script type="text/javascript">
  var game = new Phaser.Game(360, 640, Phaser.CANVAS, null, {
    preload: preload,
    create: create,
    update: update,
    render: render,
  });
  var instruction; //게임 시작 전 화면 배경
  var startBtn; //시작버튼
  var bg; // 게임 배경 이미지
  var box; // 그룹 형성용 이미지
  var player // 플레이어
  var enemy; // 회피물
  var enemyAlive; // 회피물 존재 여부
  var enemyArray = []; // 생성될 회피물의 정보
  var life = 1; // 플레이어 생명
  var timer; // 타이머
  var timerEvent; // 타이머 이벤트
  var score = 0; // 점수
  var txtScore;
  var eventScore;
  var img_1;//1
  var img_2;//2
  var img_3;//3
  var img_GO;//GO!
  var isHit=false; //충돌 유무 확인
  var player_y_record=-1;//최초 플레이어 y지점 기록
  var gameover_clear;//게임오버-성공 이미지
  var gameover_fail;//게임오버-실패 이미지


  /* -----PRELOAD----- */
  function preload() {
    //게임에 필요한 데이터 로드
    /* 게임 시작전 화면 이미지 로드 */
    game.load.image("instruction", "./images/instruction.png");
    game.load.image("startBtn", "./images/startBtn.png");
    /* 배경 이미지 로드 */
    game.load.image("background", "./images/background.png");
    /* 그룹 형성 시에 사용할 박스 이미지 로드 */
    game.load.image("box", "./images/box.png");
    /* 플레이어를 기본 32x40 크기로 설정. 'player' 이름으로 생성 */
    game.load.spritesheet("player", "./images/player.png", 256, 256);
    /* 회피물 로드 */
    game.load.image("enemy", "./images/enemy.png");
    /* 카운트다운 이미지 로드 */
    game.load.image("img_1", "./images/count/1.png");
    game.load.image("img_2", "./images/count/2.png");
    game.load.image("img_3", "./images/count/3.png");
    game.load.image("img_GO", "./images/count/GO!.png");
    /* 아이템 로드 */
    game.load.image("g_obj_01", "./images/items/g_obj_01.png");
    game.load.image("g_obj_02", "./images/items/g_obj_02.png");
    game.load.image("g_obj_03", "./images/items/g_obj_03.png");
    game.load.image("g_obj_04", "./images/items/g_obj_04.png");
    game.load.image("g_obj_05", "./images/items/g_obj_05.png");
    game.load.image("g_obj_06", "./images/items/g_obj_06.png");
    game.load.image("g_obj_07", "./images/items/g_obj_07.png");
    game.load.image("g_obj_08", "./images/items/g_obj_08.png");
    game.load.image("jadamteo", "./images/items/jadamteo.png");

    /* 게임오버 이미지 로드 */
    game.load.image("clear", "./images/clear.png");
    game.load.image("fail", "./images/fail.png");


  }




  /* -----CREATE----- */
  function create() {

    /* 게임 처음 실행 시 수행되는 함수 */
    game.physics.startSystem(Phaser.Physics.ARCADE);

    /* 배경화면 설정 */
    bg = game.add.sprite(0, 0, "background");
    //비율 설정
    bg.scale.setTo(0.5, 0.5);

    /* 게임 시작 전 화면 설정 */
    instruction = game.add.sprite(
      (game.cache.getImage("background").width - game.cache.getImage("instruction").width) / 4, game.height / 16, "instruction"
    );
    instruction.scale.setTo(0.5, 0.5);

    startBtn = game.add.button(
      (game.cache.getImage("background").width - game.cache.getImage("startBtn").width) / 4, game.height * 0.75, "startBtn", startBtnClick, this, 1, 1, 0
    );
    startBtn.scale.setTo(0.5, 0.5);

    // create a custom time
    timer = game.time.create();

    // create a delayed event 1m and 30s from now
  //  timerEvent = timer.add(Phaser.Timer.MINUTE * 2, this.endTimer, this);
  timerEvent = timer.add(Phaser.Timer.SECOND * 5, this.endTimer, this);


    /* box 그룹 생성 */
    box = game.add.group();
    box.enableBody = true; // box에 출돌속성을 설정.

    /* 회피물 생성 */
    enemy = game.add.group();


    /* Game Over */


    /* Score */
    txtScore = game.add.text(20, 10, "Score: 0", {
      fontSize: "70px Arial",
      fill: "#FFFFFF"
    });
    txtScore.visible = false;
  }



  /* -----UPDATE----- */
  function update() {
    /*  프레임워크에서 주기적으로 수행하는 함수 */
    if (life < 1) {
      return;
    }
    /* box 밖으로의 움직임 제한 */
    game.physics.arcade.collide(player, box);

    game.physics.arcade.overlap(player, enemy, enemyHitsPlayer, null, this);

    /* 플레이어 움직임 정의 */
    if (player != undefined) {
      player.body.velocity.setTo(0, 0); // 관성을 0으로 설정

      //  400 is the speed it will move towards the mouse
      //game.physics.arcade.moveToPointer(player, 400);
      game.physics.arcade.moveToXY(player, game.input.x, game.height, 1000);
      if(isHit) {
        player.animations.play("good");
      }
      else if (game.input.mousePointer.x > player.x || game.input.mousePointer.x < player.x) {
        player.animations.play("run");
      } else {
        //player.animations.stop();
        // player.frame = 3;
      }
    }




    if (enemy != undefined) {
      /* 회피물 세팅 */
      enemyAlive = enemy.getFirstExists(false);
      enemyArray.length = 0;
      // box 개수 만큼 회피물을 세팅
      box.forEachAlive(function(enemyAlive) {
        enemyArray.push(enemyAlive);
      });
      // box 중 랜덤으로 하나를 골라서 회피물 생성
      if (enemyAlive && enemyArray.length > 0) {
        var random = game.rnd.integerInRange(0, enemy.length - 1);
        //var enemyBox = enemyArray[random];
        var x = getRandomInt(10,game.width-20);
        enemyAlive.reset(x, 80);
        game.physics.arcade.moveToXY(enemyAlive, enemyAlive.x, game.height, 150);
      }
    }
  }


  /* -----RENDER----- */
  function render() {
    if (timer.running) {
      // If our timer is running, show the time in a nicely formatted way,fontSize:"70px Arial",fill: "#FFFFFF"}
      game.debug.text(formatTime(Math.round((timerEvent.delay - timer.ms) / 1000)), 80, 14, "#ff0");
    } else {
      // else show 'Done'!;
      // game.debug.text("Done!",2,14,"#0f0");
    }
  }


  /* -----ENDTIMER----- */
  function endTimer() {
    // Stop the timer when the delayed event triggers
    timer.stop();
    life = 0;
    clear = game.add.sprite(x,y, "instruction"
    );

  }


  /* -----FORMATTIMER----- */
  function formatTime(s) {
    //convert seconds (s) to a nicely formatted and padded time string
    var minutes = "0" + Math.floor(s / 60);
    var seconds = "0" + (s - minutes * 60);
    return minutes.substr(-2) + ":" + seconds.substr(-2);
  }


  function enemyHitsPlayer(playerPoint, enemy) {
    if(player_y_record==-1){
      player_y_record=player.y;
    }
    enemy.kill();
    isHit=true;
    //20 만큼 점프
    player.y=player_y_record-10;
    //life = 0;
    score++;
    txtScore.setText("Score: " + score);
    setTimeout(function() {
      isHit=false;
    }, 500);
  }

  function startBtnClick() {
    instruction.visible = false;
    startBtn.visible = false;

    /* start countdown animation */
    popupCount();
  }

  function count_GO(millisecondsToWait, ratio) {
    img_GO = game.add.sprite(
      (game.world.centerX - (game.cache.getImage("img_GO").width * 1.2) / 2), (game.world.centerY - (game.cache.getImage("img_GO").height * 1.2 / 2)), "img_GO"
    );
    img_GO.scale.setTo(1.2, 1.2);

    // pop_GO = game.add.tween(img_GO.scale).to( { x: ratio, y: ratio }, 300, Phaser.Easing.Elastic.In, true);
    setTimeout(function() {
      // pop_GO = game.add.tween(img_GO.scale).to( { x: 0, y: 0 }, 10, Phaser.Easing.Elastic.In, true);
      img_GO.visible = false;
      gameStart();
    }, millisecondsToWait);
  }

  function count_1(millisecondsToWait, ratio) {
    img_1 = game.add.sprite(
      (game.world.centerX - (game.cache.getImage("img_1").width) / 2), (game.world.centerY - (game.cache.getImage("img_1").height / 2)), "img_1"
    );

    // pop_1 = game.add.tween(img_1.scale).to( { x: ratio, y: ratio }, 300, Phaser.Easing.Elastic.In, true);
    setTimeout(function() {
      // pop_1 = game.add.tween(img_1.scale).to( { x: 0, y: 0 }, 1, Phaser.Easing.Elastic.In, true);
      // count_GO(millisecondsToWait,ratio);
      img_1.visible = false;
      count_GO(millisecondsToWait);
    }, millisecondsToWait);
  }

  function count_2(millisecondsToWait, ratio) {
    img_2 = game.add.sprite(
      (game.world.centerX - (game.cache.getImage("img_2").width) / 2), (game.world.centerY - (game.cache.getImage("img_2").height / 2)), "img_2"
    );

    // pop_2 = game.add.tween(img_2.scale).to( { x: ratio, y: ratio }, 300, Phaser.Easing.Elastic.In, true);
    setTimeout(function() {
      // pop_2 = game.add.tween(img_2.scale).to( { x: 0, y: 0 }, 1, Phaser.Easing.Elastic.In, true);
      // count_1(millisecondsToWait,ratio);
      img_2.visible = false;
      count_1(millisecondsToWait);
    }, millisecondsToWait);
  }

  function count_3(millisecondsToWait, ratio) {
    img_3 = game.add.sprite(
      (game.world.centerX - (game.cache.getImage("img_3").width) / 2), (game.world.centerY - (game.cache.getImage("img_3").height / 2)), "img_3"
    );
    // img_3.anchor.set(0.5);
    // img_3.smoothed = false;
    //
    // game.physics.enable(img_3, Phaser.Physics.ARCADE);
    // img_3.body.immovable = true;



    // pop_3 = game.add.tween(img_3.scale).to( { x: ratio, y: ratio }, 300, Phaser.Easing.Elastic.In, true);
    // game.add.tween(img_3.scale).to( { x: ratio, y: ratio }, 300, Phaser.Easing.Linear.None, true);
    setTimeout(function() {
      // pop_3 = game.add.tween(img_3.scale).to( { x: 0, y: 0 }, 1, Phaser.Easing.Elastic.In, true);
      // count_2(millisecondsToWait,ratio);
      img_3.visible = false;
      count_2(millisecondsToWait);
    }, millisecondsToWait);
  }

  function popupCount() {
    var millisecondsToWait = 700;
    //var ratio=2;

    //count_3(millisecondsToWait,ratio);
    count_3(millisecondsToWait);
  }

  function gameStart() {
    for (var i = 0; i < game.width / 10; i++) {
      var rowBox = box.create(i * 10, 80, "box");
      rowBox.body.immovable = true; // box가 움직이지 못하도록 설정
      rowBox = box.create(i * 10, game.height - 10, "box");
      rowBox.body.immovable = true; // box가 움직이지 못하도록 설정
    }
    for (var j = 9; j < game.height / 10; j++) {
      var colBox = box.create(0, j * 10, "box");
      colBox.body.immovable = true; // box가 움직이지 못하도록 설정
      colBox = box.create(game.width - 10, j * 10, "box");
      colBox.body.immovable = true; // box가 움직이지 못하도록 설정
    }

    /* 플레이어 추가 */
    player = game.add.sprite((game.width) / 2, (game.height) / 2, "player");
    player.scale.setTo(0.5,0.5);
    game.physics.arcade.enable(player);
    // 평상시 뛰는 애니메이션
    player.animations.add("run", [0, 1, 2, 3, 4, 5, 6, 7], 10, true);
    // 긍정적 아이템 습득시 애니메이션
    player.animations.add("good", [9], 10, false);
    // 부정적 아이템 습득시 애니메이션
    player.animations.add("bad", [8], 10, false);

    enemy.enableBody = true;
    enemy.physicsBodyType = Phaser.Physics.ARCADE;
    enemy.createMultiple(5, "g_obj_01");
    enemy.scale.setTo(0.2,0.2);
    // enemy 변수가 게임 레이어 밖으로 벗어나면 해당 객체를 삭제
    enemy.setAll("outOfBoundsKill", true);
    enemy.setAll("checkWorldBounds", true);

    txtScore.visible = true;

    // start the timer
    timer.start();

  }

  /**
 * Randomize array element order in-place.
 * Using Durstenfeld shuffle algorithm.
 */
function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }
    return array;
}

/**
 * Returns a random integer between min (inclusive) and max (inclusive)
 * Using Math.round() will give you a non-uniform distribution!
 */
function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

</script>

</html>
