<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Pulmuone</title>
  <style media="screen">

  </style>
</head>

<body>
</body>
<script type="text/javascript" src="./js/phaser.min.js"></script>
<script type="text/javascript" src="./js/phaser-spine.min.js"></script>
<script type="text/javascript">
  var game = new Phaser.Game(360, 640, Phaser.CANVAS, null, {
    preload: preload,
    create: create,
    update: update
  });
  /* 배경 설정 */
  var bg; // 게임 배경 이미지
  var box; // 그룹 형성용 이미지
  /* 플레이어 설정 */
  var player // 플레이어
  /* 최상단에서 생성되는 회피물 설정 */
  var enemy; // 회피물
  var enemyAlive; // 회피물 존재 여부
  var enemyArray = []; // 생성될 회피물의 정보

  function preload() {
    //게임에 필요한 데이터 로드
    /* 배경 이미지 로드 */
    game.load.image("background", "./images/background.png");
    /* 그룹 형성 시에 사용할 박스 이미지 로드 */
    game.load.image("box", "./images/box.png");
    /* 플레이어를 기본 32x40 크기로 설정. 'player' 이름으로 생성 */
    game.load.spritesheet("player", "./images/player.png", 32, 40);
    /* 회피물 로드 */
    game.load.image("enemy","./images/enemy.png");
  }

  function create() {
    /* 게임 처음 실행 시 수행되는 함수 */
    game.physics.startSystem(Phaser.Physics.ARCADE);
    /* 배경화면 설정 */
    bg = game.add.sprite(0, 0, "background");
    //비율 설정
    bg.scale.setTo(0.5, 0.5);

    /* box 그룹 생성 */
    box = game.add.group();
    box.enableBody = true; // box에 출돌속성을 설정.
    for (var i = 0; i < game.width / 40; i++) {
      var rowBox = box.create(i * 40, 80, "box");
      rowBox.body.immovable =  true; // box가 움직이지 못하도록 설정
      rowBox = box.create(i * 40, game.height - 40, "box");
      rowBox.body.immovable = true; // box가 움직이지 못하도록 설정
    }
    for (var j = 3; j < game.height / 40; j++) {
      var colBox = box.create(0, j * 40, "box");
      colBox.body.immovable = true; // box가 움직이지 못하도록 설정
      colBox = box.create(game.width - 40, j * 40, "box");
      colBox.body.immovable = true; // box가 움직이지 못하도록 설정
    }

    /* 플레이어 추가 */
    player = game.add.sprite((game.width)/2,game.height-80,"player");
    game.physics.arcade.enable(player);
    // 0,1,2 번째 프레임을 0.1초 단위로 반복하는 애니메이션 생성
    player.animations.add("left", [0,1,2],10,true);
    // 4,5,6 번째 프레임을 0.1초 단위로 반복하는 애니메이션 생성
    player.animations.add("right", [4,5,6],10,true);

    /* 회피물 생성 */
    enemy = game.add.group();
    enemy.enableBody = true;
    enemy.physicsBodyType = Phaser.Physics.ARCADE;
    enemy.createMultiple(30,"enemy");
    // enemy 변수가 겡미 레이어 밖으로 벗어나면 해당 객체를 삭제
    enemy.setAll("outOfBoundsKill",true);
    enemy.setAll("checkWorldBounds", true);
  }

  function update() {
    /*  프레임워크에서 주기적으로 수행하는 함수 */

    /* box 밖으로의 움직임 제한 */
    game.physics.arcade.collide(player,box);

    /* 플레이어 움직임 정의 */
    player.body.velocity.setTo(0,0); // 관성을 0으로 설정

    //  400 is the speed it will move towards the mouse
    //game.physics.arcade.moveToPointer(player, 400);
    game.physics.arcade.moveToXY(player,game.input.x,game.height,1000);
    if(game.input.mousePointer.x > player.x) {
      player.animations.play("right");
    } else if (game.input.mousePointer.x < player.x){
      player.animations.play("left");
    } else {
      player.animations.stop();
      player.frame = 3;
    }

    /* 회피물 세팅 */
    enemyAlive = enemy.getFirstExists(false);
    enemyArray.length = 0;
    // box 개수 만큼 회피물을 세팅
    box.forEachAlive(function(enemyAlive) {
      enemyArray.push(enemyAlive);
    });
    // box 중 랜덤으로 하나를 골라서 회피물 생성
    if( enemyAlive && enemyArray.length > 0) {
      var random = game.rnd.integerInRange(0, enemy.length-1);
      var enemyBox = enemyArray[random];
      enemyAlive.reset(enemyBox.body.x, 80);
      game.physics.arcade.moveToXY(enemyAlive, enemyAlive.x,game.height, 150);
    }
  }
</script>

</html>
